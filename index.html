<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <!-- META TAGS PWA -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LEGO Manager">
  <meta name="theme-color" content="#d32f2f">

  <!-- PWA MANIFEST -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  
  <title>Tri Pi√®ces LEGO (Bulk Mode - IndexedDB)</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="./styles.css">

  <script src="./unified-data-manager.js"></script>
  <script src="./debug.js"></script>
  <script>
    // D√©tection automatique du chemin de base
    const BASE_PATH = window.location.pathname.includes('/lego-manager/') 
      ? '/lego-manager' 
      : '';

    function navigateTo(page) {
      window.location.href = `${BASE_PATH}/${page}`;
    }
  </script>
</head>

<body>
  <div class="container">
    <h1>Mode vrac : Tri des pi√®ces LEGO (IndexedDB)</h1>
    
    <div id="file-manager" class="file-manager-section">
      <h3>Statut de la base de donn√©es LEGO (IndexedDB)</h3>
      <p>T√©l√©chargez et d√©compressez automatiquement les fichiers depuis Rebrickable.</p>
      
      <!-- Statut de la base de donn√©es -->
      <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center;">
        <strong>Base de donn√©es :</strong> <span id="db-status">Initialisation...</span>
      </div>

      <!-- Instructions -->
      <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196f3;">
        <h4 style="margin-top: 0;">üìã Instructions</h4>
        <ol style="margin-bottom: 0;">
          <li>Cliquez sur <strong>"üì• T√©l√©charger"</strong> pour chaque fichier</li>
          <li>Le fichier .gz sera automatiquement d√©compress√© et import√©</li>
          <li>Une fois tous les fichiers charg√©s, cliquez sur <strong>"‚ñ∂Ô∏è Lancer l'application"</strong></li>
        </ol>
      </div>
      
      <!-- Liste des fichiers avec boutons de t√©l√©chargement -->
      <div class="file-status" id="file-status">
        <!-- Les statuts des fichiers seront affich√©s ici -->
      </div>

      <!-- Input cach√© pour le t√©l√©chargement de fichiers .gz -->
      <input type="file" id="gz-file-input" accept=".gz" style="display: none;">
      
      <!-- Boutons d'action -->
      <div style="text-align: center; margin: 20px 0;">
        <button class="btn" id="launch-app" onclick="launchApp()" disabled>
          ‚ñ∂Ô∏è Lancer l'application
        </button>
        <button class="btn btn-danger" onclick="clearAllData()">
          üóëÔ∏è Effacer toutes les donn√©es
        </button>
      </div>
    </div>
    
    <!-- Section cach√©e pour redirection -->
    <div id="app" class="hidden">
      <div class="loading">Redirection vers l'application...</div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="./lego-db.js"></script>
  <script src="./gz-decompressor.js"></script>

  <script>
    let db = null;
    let csvWorker = null;
    let decompressor = null;

    window.onload = async function() {
      console.log('Initialisation de l\'application...');
      
      // Initialiser la base de donn√©es
      db = new window.LegoDatabase();
      await db.init();
      await db.verifyAndRepairStores();
      
      // Initialiser le d√©compresseur
      decompressor = new GzDecompressor();
      
      // Initialiser le worker CSV
      csvWorker = window.createCSVWorker();
      
      // Configurer l'interface
      renderFileList();
      setupGzFileInput();
      await updateFileStatus();
      
      console.log('Application initialis√©e');
    };

    function renderFileList() {
      const statusDiv = document.getElementById('file-status');
      statusDiv.innerHTML = '';

      for (const fileKey of Object.keys(REQUIRED_FILES)) {
        const file = REQUIRED_FILES[fileKey];
        const fileDiv = document.createElement('div');
        fileDiv.className = 'file-item missing';
        fileDiv.id = `file-${fileKey}`;
        fileDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div style="flex: 1; min-width: 200px;">
              <div class="file-name" style="font-weight: bold; margin-bottom: 5px;">${file.name}</div>
              <div class="file-status-text missing" style="font-size: 0.9em;">‚ùå Manquant</div>
              <div style="font-size: 0.85em; color: #666;">${file.description}</div>
            </div>
            <div style="min-width: 150px; text-align: right;">
              <button class="btn btn-sm download-btn" 
                      onclick="downloadFile('${fileKey}')" 
                      id="download-btn-${fileKey}">
                üì• T√©l√©charger
              </button>
            </div>
          </div>
          <div class="progress-bar" id="progress-${fileKey}" style="display:none; margin-top: 10px;">
            <div class="progress-fill" id="progress-fill-${fileKey}"></div>
          </div>
        `;
        statusDiv.appendChild(fileDiv);
      }
    }

    function setupGzFileInput() {
      const gzInput = document.getElementById('gz-file-input');
      gzInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // R√©cup√©rer le fileKey stock√© temporairement
        const fileKey = gzInput.dataset.fileKey;
        
        try {
          await processGzFile(file, fileKey);
        } catch (error) {
          console.error('Erreur traitement fichier .gz:', error);
          showErrorMessage(`Erreur: ${error.message}`);
          
          const fileDiv = document.getElementById(`file-${fileKey}`);
          fileDiv.className = 'file-item missing';
          fileDiv.querySelector('.file-status-text').textContent = '‚ùå Erreur';
          fileDiv.querySelector('.file-status-text').className = 'file-status-text missing';
        }
        
        // R√©initialiser l'input
        e.target.value = '';
      });
    }

    function downloadFile(fileKey) {
      const file = REQUIRED_FILES[fileKey];
      const gzInput = document.getElementById('gz-file-input');
      
      // Stocker le fileKey pour l'utiliser apr√®s la s√©lection
      gzInput.dataset.fileKey = fileKey;
      
      // Message √† l'utilisateur
      showInfoMessage(`Veuillez t√©l√©charger le fichier ${file.name} depuis votre navigateur, puis le s√©lectionner.`);
      
      // Ouvrir le lien de t√©l√©chargement dans un nouvel onglet
      window.open(file.url, '_blank');
      
      // Ouvrir le s√©lecteur de fichier apr√®s un court d√©lai
      setTimeout(() => {
        gzInput.click();
      }, 1000);
    }

    async function processGzFile(file, fileKey) {
      const fileDiv = document.getElementById(`file-${fileKey}`);
      const progressBar = document.getElementById(`progress-${fileKey}`);
      const progressFill = document.getElementById(`progress-fill-${fileKey}`);
      const downloadBtn = document.getElementById(`download-btn-${fileKey}`);

      try {
        fileDiv.className = 'file-item processing';
        fileDiv.querySelector('.file-status-text').textContent = '‚è≥ D√©compression...';
        fileDiv.querySelector('.file-status-text').className = 'file-status-text processing';
        progressBar.style.display = 'block';
        downloadBtn.disabled = true;

        // Lire le fichier .gz
        const arrayBuffer = await file.arrayBuffer();
        const compressed = new Uint8Array(arrayBuffer);
        
        progressFill.style.width = '30%';
        
        // D√©compresser
        await decompressor.loadPako();
        const decompressed = decompressor.pako.inflate(compressed);
        
        progressFill.style.width = '50%';
        fileDiv.querySelector('.file-status-text').textContent = '‚è≥ Conversion...';
        
        // Convertir en texte
        const decoder = new TextDecoder('utf-8');
        const csvText = decoder.decode(decompressed);
        
        console.log(`‚úÖ ${file.name} d√©compress√©: ${csvText.length.toLocaleString()} caract√®res`);
        
        progressFill.style.width = '60%';
        fileDiv.querySelector('.file-status-text').textContent = '‚è≥ Analyse CSV...';
        
        // Analyser le CSV
        const data = await new Promise((resolve, reject) => {
          csvWorker.onmessage = (e) => {
            if (e.data.type === "progress") {
              progressFill.style.width = `${60 + e.data.value * 20}%`;
            } else if (e.data.type === "done") {
              resolve(e.data.data);
            }
          };
          csvWorker.onerror = reject;
          csvWorker.postMessage({ text: csvText });
        });

        if (data.length === 0) {
          throw new Error('Aucune donn√©e valide trouv√©e');
        }

        progressFill.style.width = '80%';
        fileDiv.querySelector('.file-status-text').textContent = 'üì¶ Enregistrement...';

        // Nettoyer les donn√©es
        let cleanedData = data;
        if (fileKey === "parts") cleanedData = window.cleanPartsData(data);
        if (fileKey === "inventory_parts") cleanedData = window.cleanInventoryPartsData(data);
        if (fileKey === "part_categories") cleanedData = window.cleanCategoriesData(data);
        if (fileKey === "colors") cleanedData = window.cleanColorsData(data);
        if (fileKey === "sets") cleanedData = window.cleanSetsData(data);
        if (fileKey === "inventories") cleanedData = window.cleanInventoriesData(data);
        if (fileKey === "minifigs") cleanedData = window.cleanMinifigsData(data);
        if (fileKey === "inventory_minifigs") cleanedData = window.cleanInventoryMinifigsData(data);

        // Sauvegarder dans IndexedDB
        await db.saveData(fileKey, cleanedData, (current, total) => {
          const percentage = 80 + (current / total) * 20;
          progressFill.style.width = `${percentage}%`;
        });

        await db.setFileDate(fileKey, Date.now());

        progressFill.style.width = '100%';
        
        setTimeout(() => {
          fileDiv.className = 'file-item loaded';
          fileDiv.querySelector('.file-status-text').textContent = '‚úÖ Charg√©';
          fileDiv.querySelector('.file-status-text').className = 'file-status-text loaded';
          progressBar.style.display = 'none';
          
          // Remplacer le bouton par un indicateur de succ√®s
          downloadBtn.innerHTML = '‚úÖ Charg√©';
          downloadBtn.className = 'btn btn-sm btn-success';
          downloadBtn.disabled = true;
        }, 500);

        showSuccessMessage(`${REQUIRED_FILES[fileKey].name}: ${cleanedData.length.toLocaleString()} enregistrements charg√©s`);
        
        await updateFileStatus();

      } catch (error) {
        console.error('Erreur:', error);
        fileDiv.className = 'file-item missing';
        fileDiv.querySelector('.file-status-text').textContent = '‚ùå Erreur';
        fileDiv.querySelector('.file-status-text').className = 'file-status-text missing';
        progressBar.style.display = 'none';
        downloadBtn.disabled = false;
        
        throw error;
      }
    }

    async function updateFileStatus() {
      const launchBtn = document.getElementById('launch-app');
      let allFilesLoaded = true;

      for (const fileKey of Object.keys(REQUIRED_FILES)) {
        const count = await db.getTableCount(fileKey);
        const isLoaded = count > 0;
        
        if (!isLoaded) {
          allFilesLoaded = false;
        } else {
          const fileDiv = document.getElementById(`file-${fileKey}`);
          const downloadBtn = document.getElementById(`download-btn-${fileKey}`);
          
          if (downloadBtn && !downloadBtn.classList.contains('btn-success')) {
            downloadBtn.innerHTML = '‚úÖ Charg√©';
            downloadBtn.className = 'btn btn-sm btn-success';
            downloadBtn.disabled = true;
          }
          
          const fileDate = await db.getFileDate(fileKey);
          const fileDateText = fileDate ? new Date(fileDate).toLocaleDateString() : 'Date inconnue';
          
          fileDiv.className = 'file-item loaded';
          fileDiv.querySelector('.file-status-text').textContent = '‚úÖ Charg√©';
          fileDiv.querySelector('.file-status-text').className = 'file-status-text loaded';
          
          // Ajouter info de comptage si pas d√©j√† pr√©sent
          if (!fileDiv.querySelector('.file-count')) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'file-count';
            infoDiv.style.fontSize = '0.8em';
            infoDiv.style.color = '#666';
            infoDiv.style.marginTop = '5px';
            infoDiv.innerHTML = `${count.toLocaleString()} enregistrements ‚Ä¢ ${fileDateText}`;
            fileDiv.querySelector('.file-status-text').after(infoDiv);
          }
        }
      }

      launchBtn.disabled = !allFilesLoaded;
      document.getElementById("db-status").textContent = allFilesLoaded
        ? "‚úÖ Base op√©rationnelle"
        : "‚ÑπÔ∏è Base partielle ou incompl√®te";
    }

    async function clearAllData() {
      if (confirm('Effacer TOUTES les donn√©es ? Cette action est irr√©versible.')) {
        try {
          await resetDatabase();
          location.reload();
        } catch (error) {
          showErrorMessage(`Erreur: ${error.message}`);
        }
      }
    }

    async function resetDatabase() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.deleteDatabase("LegoPartsDB");
        req.onsuccess = () => resolve();
        req.onerror = reject;
      });
    }

    async function launchApp() {
      const allFilesLoaded = await checkAllFilesLoaded();
      if (allFilesLoaded) {
        navigateTo('menu.html');
      } else {
        showErrorMessage('Tous les fichiers doivent √™tre charg√©s avant de lancer l\'application.');
      }
    }

    async function checkAllFilesLoaded() {
      for (const fileKey of Object.keys(REQUIRED_FILES)) {
        const count = await db.getTableCount(fileKey);
        if (count === 0) return false;
      }
      return true;
    }

    function showErrorMessage(message) {
      showMessage(message, 'error');
    }

    function showInfoMessage(message) {
      showMessage(message, 'info');
    }

    function showSuccessMessage(message) {
      showMessage(message, 'success');
    }

    function showMessage(message, type) {
      const oldMessages = document.querySelectorAll('.temp-message');
      oldMessages.forEach(msg => msg.remove());
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `temp-message ${type === 'success' ? 'success' : type === 'error' ? 'error' : 'update-section'}`;
      messageDiv.innerHTML = `<p>${message}</p>`;
      
      document.body.insertBefore(messageDiv, document.body.firstChild);
      
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 8000);
    }
  </script>

  <!-- SERVICE WORKER -->
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('‚úÖ Service Worker enregistr√©', reg.scope))
        .catch(err => console.error('‚ùå Erreur Service Worker:', err));
    });
  }
  </script>
  <script src="./install-prompt.js"></script>
</body>
</html>