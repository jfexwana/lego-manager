<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <!-- META TAGS PWA -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LEGO Manager">
  <meta name="theme-color" content="#d32f2f">

  <!-- PWA MANIFEST -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  
  <title>Tri Pi√®ces LEGO (Bulk Mode - IndexedDB)</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="./styles.css">

  <script src="./unified-data-manager.js"></script>
  <script src="./debug.js"></script>
  <script>
    // D√©tection automatique du chemin de base
    const BASE_PATH = window.location.pathname.includes('/lego-manager/') 
      ? '/lego-manager' 
      : '';

    function navigateTo(page) {
      window.location.href = `${BASE_PATH}/${page}`;
    }
  </script>
</head>

<body>
  <div class="container">
    <h1>Mode vrac : Tri des pi√®ces LEGO (IndexedDB)</h1>
    
    <div id="file-manager" class="file-manager-section">
      <h3>Statut de la base de donn√©es LEGO (IndexedDB)</h3>
      <p>T√©l√©chargement et d√©compression automatiques depuis Rebrickable, ou import manuel de fichiers CSV.</p>
      
      <!-- Statut de la base de donn√©es -->
      <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center;">
        <strong>Base de donn√©es :</strong> <span id="db-status">Initialisation...</span>
      </div>
      
      <div class="file-status" id="file-status">
        <!-- Les statuts des fichiers seront affich√©s ici -->
      </div>
      
      <!-- Boutons d'action principaux -->
      <div style="text-align: center; margin: 20px 0; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
        <button class="btn" id="download-all-btn" onclick="downloadAllFiles()">
          üì• T√©l√©charger depuis Rebrickable
        </button>
        <button class="btn" onclick="document.getElementById('file-input').click()">
          üìÅ Importer des CSV manuellement
        </button>
        <button class="btn btn-warning" onclick="checkForUpdates()">
          üîÑ V√©rifier les mises √† jour
        </button>
        <button class="btn" id="launch-app" onclick="launchApp()" disabled>
          ‚ñ∂Ô∏è Lancer l'application
        </button>
        <button class="btn btn-danger" onclick="clearAllData()">
          üóëÔ∏è Effacer toutes les donn√©es
        </button>
      </div>

      <!-- Barre de progression globale -->
      <div id="global-progress" style="display: none; margin: 20px 0;">
        <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden; height: 30px;">
          <div id="global-progress-bar" style="background: linear-gradient(90deg, #4caf50, #2196f3); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9em;">
            0%
          </div>
        </div>
        <div id="global-progress-text" style="text-align: center; margin-top: 10px; font-size: 0.9em; color: #666; font-weight: 500;">
          Initialisation...
        </div>
      </div>
      
      <!-- Zone d'upload manuel (cach√©e par d√©faut) -->
      <div class="upload-area" id="upload-area" style="display: none; margin-top: 20px;">
        <p>Glissez-d√©posez vos fichiers CSV d√©compress√©s ici</p>
        <input type="file" id="file-input" multiple accept=".csv" style="display: none;">
        <p><small>Fichiers accept√©s : parts.csv, part_categories.csv, inventory_parts.csv, colors.csv, sets.csv, inventories.csv, minifigs.csv, inventory_minifigs.csv</small></p>
      </div>

      <!-- Instructions d√©taill√©es (repliables) -->
      <details style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <summary style="cursor: pointer; font-weight: bold; color: #2196f3;">
          ‚ÑπÔ∏è Instructions d√©taill√©es
        </summary>
        <div class="upload-instructions" style="margin-top: 15px;">
          <h4>Option 1 : T√©l√©chargement automatique (Recommand√©)</h4>
          <ol>
            <li>Cliquez sur <strong>"üì• T√©l√©charger depuis Rebrickable"</strong></li>
            <li>Attendez 5-10 minutes (les fichiers sont t√©l√©charg√©s et d√©compress√©s automatiquement)</li>
            <li>Cliquez sur <strong>"‚ñ∂Ô∏è Lancer l'application"</strong></li>
          </ol>

          <h4>Option 2 : Import manuel</h4>
          <ol>
            <li>T√©l√©chargez les fichiers .gz depuis Rebrickable (liens ci-dessous)</li>
            <li>D√©compressez-les avec 7-Zip, WinRAR ou un outil similaire</li>
            <li>Cliquez sur <strong>"üìÅ Importer des CSV manuellement"</strong></li>
            <li>S√©lectionnez les fichiers CSV d√©compress√©s</li>
          </ol>

          <h4>Fichiers requis :</h4>
          <ul style="font-size: 0.9em;">
            <li><strong>parts.csv.gz</strong> - <a href="https://cdn.rebrickable.com/media/downloads/parts.csv.gz" target="_blank">T√©l√©charger</a></li>
            <li><strong>part_categories.csv.gz</strong> - <a href="https://cdn.rebrickable.com/media/downloads/part_categories.csv.gz" target="_blank">T√©l√©charger</a></li>
            <li><strong>inventory_parts.csv.gz</strong> - <a href="https://cdn.rebrickable.com/media/downloads/inventory_parts.csv.gz" target="_blank">T√©l√©charger</a></li>
            <li><strong>colors.csv.gz</strong> - <a href="https://cdn.rebrickable.com/media/downloads/colors.csv.gz" target="_blank">T√©l√©charger</a></li>
            <li><strong>sets.csv.gz</strong> - <a href="https://cdn.rebrickable.com/media/downloads/sets.csv.gz" target="_blank">T√©l√©charger</a></li>
            <li><strong>inventories.csv.gz</strong> - <a href="https://cdn.rebrickable.com/media/downloads/inventories.csv.gz" target="_blank">T√©l√©charger</a></li>
            <li><strong>minifigs.csv.gz</strong> - <a href="https://cdn.rebrickable.com/media/downloads/minifigs.csv.gz" target="_blank">T√©l√©charger</a></li>
            <li><strong>inventory_minifigs.csv.gz</strong> - <a href="https://cdn.rebrickable.com/media/downloads/inventory_minifigs.csv.gz" target="_blank">T√©l√©charger</a></li>
          </ul>
        </div>
      </details>
    </div>
    
    <!-- Section cach√©e pour redirection -->
    <div id="app" class="hidden">
      <div class="loading">Redirection vers l'application...</div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="./lego-db.js"></script>
  <script src="./gz-decompressor.js"></script>

  <script>
    let db = null;
    let csvWorker = null;
    let decompressor = null;

    window.onload = async function() {
      console.log('Initialisation de l\'application...');
      
      // Initialiser la base de donn√©es
      db = new window.LegoDatabase();
      await db.init();
      await db.verifyAndRepairStores();
      
      // Initialiser le d√©compresseur
      decompressor = new GzDecompressor();
      
      // Initialiser le worker CSV
      csvWorker = window.createCSVWorker();
      
      // Configurer l'interface
      renderInitialFileStatus();
      setupFileManager();
      await updateFileStatus();
      
      console.log('Application initialis√©e');
    };

    function renderInitialFileStatus() {
      const statusDiv = document.getElementById('file-status');
      statusDiv.innerHTML = '';

      for (const fileKey of Object.keys(REQUIRED_FILES)) {
        const file = REQUIRED_FILES[fileKey];
        const fileDiv = document.createElement('div');
        fileDiv.className = 'file-item missing';
        fileDiv.id = `file-${fileKey}`;
        fileDiv.innerHTML = `
          <div class="file-name">${file.name}</div>
          <div class="file-status-text missing">‚ùå Manquant</div>
          <div style="font-size: 0.85em; color: #666;">${file.description}</div>
          <div class="progress-bar" id="progress-${fileKey}" style="display:none;">
            <div class="progress-fill" id="progress-fill-${fileKey}"></div>
          </div>
        `;
        statusDiv.appendChild(fileDiv);
      }
    }

    function setupFileManager() {
      const uploadArea = document.getElementById('upload-area');
      const fileInput = document.getElementById('file-input');
      
      uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
        uploadArea.style.display = 'block';
      });
      
      uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });
      
      fileInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
      });
    }

    async function updateFileStatus() {
      const launchBtn = document.getElementById('launch-app');
      let allFilesLoaded = true;

      for (const fileKey of Object.keys(REQUIRED_FILES)) {
        const fileDiv = document.getElementById(`file-${fileKey}`);
        const count = await db.getTableCount(fileKey);
        const fileDate = await db.getFileDate(fileKey);

        const isLoaded = count > 0;
        if (!isLoaded) allFilesLoaded = false;

        const fileDateText = fileDate ? new Date(fileDate).toLocaleDateString() : 'Date inconnue';

        fileDiv.className = `file-item ${isLoaded ? 'loaded' : 'missing'}`;
        fileDiv.querySelector('.file-status-text').textContent = isLoaded ? '‚úÖ Charg√©' : '‚ùå Manquant';
        fileDiv.querySelector('.file-status-text').className = `file-status-text ${isLoaded ? 'loaded' : 'missing'}`;

        if (isLoaded) {
          const existingButtons = fileDiv.querySelectorAll('.btn-danger, .update-button');
          existingButtons.forEach(btn => btn.remove());
          
          const countDiv = fileDiv.querySelector('.file-count');
          if (!countDiv) {
            fileDiv.innerHTML += `
              <div class="file-count">${count.toLocaleString()} enregistrements</div>
              <div class="file-count">Date: ${fileDateText}</div>
              <button class="download-link btn-danger" onclick="removeFile('${fileKey}')">üóëÔ∏è Supprimer</button>
            `;
          }
        }
      }

      launchBtn.disabled = !allFilesLoaded;
      document.getElementById("db-status").textContent = allFilesLoaded
        ? "‚úÖ Base op√©rationnelle"
        : "‚ÑπÔ∏è Base partielle ou incompl√®te";
    }

    // ============================================
    // T√âL√âCHARGEMENT AUTOMATIQUE DEPUIS REBRICKABLE
    // ============================================
    async function downloadAllFiles() {
      const downloadBtn = document.getElementById('download-all-btn');
      downloadBtn.disabled = true;
      downloadBtn.innerHTML = '‚è≥ T√©l√©chargement...';
      
      const globalProgress = document.getElementById('global-progress');
      const globalProgressBar = document.getElementById('global-progress-bar');
      const globalProgressText = document.getElementById('global-progress-text');
      
      globalProgress.style.display = 'block';
      
      const files = Object.keys(REQUIRED_FILES);
      let completedFiles = 0;
      
      for (const fileKey of files) {
        const file = REQUIRED_FILES[fileKey];
        
        try {
          globalProgressText.textContent = `üì• T√©l√©chargement de ${file.name}...`;
          
          const fileDiv = document.getElementById(`file-${fileKey}`);
          const progressBar = document.getElementById(`progress-${fileKey}`);
          const progressFill = document.getElementById(`progress-fill-${fileKey}`);
          
          fileDiv.className = 'file-item processing';
          fileDiv.querySelector('.file-status-text').textContent = '‚è≥ T√©l√©chargement...';
          fileDiv.querySelector('.file-status-text').className = 'file-status-text processing';
          progressBar.style.display = 'block';
          
          // T√©l√©charger et d√©compresser
          const csvText = await decompressor.downloadAndDecompress(
            file.url,
            (progress) => {
              const percent = Math.min(95, progress.percentage.toFixed(0));
              progressFill.style.width = `${percent}%`;
            }
          );
          
          fileDiv.querySelector('.file-status-text').textContent = '‚è≥ Analyse CSV...';
          
          // Analyser le CSV
          const data = await new Promise((resolve, reject) => {
            csvWorker.onmessage = (e) => {
              if (e.data.type === "done") {
                resolve(e.data.data);
              }
            };
            csvWorker.onerror = reject;
            csvWorker.postMessage({ text: csvText });
          });
          
          if (data.length === 0) {
            throw new Error('Aucune donn√©e valide trouv√©e');
          }
          
          fileDiv.querySelector('.file-status-text').textContent = 'üì¶ Enregistrement...';
          
          // Nettoyer les donn√©es
          let cleanedData = data;
          if (fileKey === "parts") cleanedData = window.cleanPartsData(data);
          if (fileKey === "inventory_parts") cleanedData = window.cleanInventoryPartsData(data);
          if (fileKey === "part_categories") cleanedData = window.cleanCategoriesData(data);
          if (fileKey === "colors") cleanedData = window.cleanColorsData(data);
          if (fileKey === "sets") cleanedData = window.cleanSetsData(data);
          if (fileKey === "inventories") cleanedData = window.cleanInventoriesData(data);
          if (fileKey === "minifigs") cleanedData = window.cleanMinifigsData(data);
          if (fileKey === "inventory_minifigs") cleanedData = window.cleanInventoryMinifigsData(data);
          
          // Sauvegarder dans IndexedDB
          await db.saveData(fileKey, cleanedData);
          await db.setFileDate(fileKey, Date.now());
          
          fileDiv.className = 'file-item loaded';
          fileDiv.querySelector('.file-status-text').textContent = '‚úÖ Charg√©';
          fileDiv.querySelector('.file-status-text').className = 'file-status-text loaded';
          progressBar.style.display = 'none';
          
          completedFiles++;
          const globalPercent = ((completedFiles / files.length) * 100).toFixed(0);
          globalProgressBar.style.width = `${globalPercent}%`;
          globalProgressBar.textContent = `${globalPercent}%`;
          
          console.log(`‚úÖ ${file.name}: ${cleanedData.length.toLocaleString()} enregistrements`);
          
        } catch (error) {
          console.error(`‚ùå Erreur avec ${file.name}:`, error);
          const fileDiv = document.getElementById(`file-${fileKey}`);
          fileDiv.className = 'file-item missing';
          fileDiv.querySelector('.file-status-text').textContent = '‚ùå Erreur';
          fileDiv.querySelector('.file-status-text').className = 'file-status-text missing';
          
          showErrorMessage(`Erreur avec ${file.name}: ${error.message}`);
        }
      }
      
      globalProgressText.textContent = '‚úÖ T√©l√©chargement termin√© !';
      
      setTimeout(() => {
        globalProgress.style.display = 'none';
      }, 3000);
      
      downloadBtn.disabled = false;
      downloadBtn.innerHTML = 'üì• T√©l√©charger depuis Rebrickable';
      
      await updateFileStatus();
    }

    // ============================================
    // IMPORT MANUEL DE CSV
    // ============================================
    async function handleFiles(files) {
      document.getElementById('upload-area').style.display = 'block';
      
      for (let file of files) {
        if (!file.name.endsWith('.csv')) {
          showErrorMessage(`Fichier ignor√©: ${file.name} (seuls les .csv sont accept√©s)`);
          continue;
        }
        
        let fileKey = null;
        const lowerName = file.name.toLowerCase();

        if (lowerName === 'parts.csv') fileKey = 'parts';
        else if (lowerName === 'part_categories.csv') fileKey = 'part_categories';
        else if (lowerName === 'inventory_parts.csv') fileKey = 'inventory_parts';
        else if (lowerName === 'colors.csv') fileKey = 'colors';
        else if (lowerName === 'sets.csv') fileKey = 'sets';
        else if (lowerName === 'inventories.csv') fileKey = 'inventories';
        else if (lowerName === 'minifigs.csv') fileKey = 'minifigs';
        else if (lowerName === 'inventory_minifigs.csv') fileKey = 'inventory_minifigs';
        
        if (!fileKey) {
          showErrorMessage(`Type de fichier non reconnu: ${file.name}`);
          continue;
        }
        
        await processFile(file, fileKey);
      }
      
      await updateFileStatus();
    }

    async function processFile(file, fileKey) {
      const fileDiv = document.getElementById(`file-${fileKey}`);
      const progressBar = document.getElementById(`progress-${fileKey}`);
      const progressFill = document.getElementById(`progress-fill-${fileKey}`);

      try {
        fileDiv.className = 'file-item processing';
        fileDiv.querySelector('.file-status-text').textContent = '‚è≥ Lecture...';
        fileDiv.querySelector('.file-status-text').className = 'file-status-text processing';
        progressBar.style.display = 'block';

        const text = await file.text();
        if (text.length < 100) throw new Error('Fichier trop petit ou vide');

        fileDiv.querySelector('.file-status-text').textContent = '‚è≥ Analyse CSV...';
        progressFill.style.width = '10%';

        const data = await new Promise((resolve, reject) => {
          csvWorker.onmessage = (e) => {
            if (e.data.type === "progress") {
              progressFill.style.width = `${10 + e.data.value * 40}%`;
            } else if (e.data.type === "done") {
              resolve(e.data.data);
            }
          };
          csvWorker.onerror = reject;
          csvWorker.postMessage({ text });
        });

        if (data.length === 0) throw new Error('Aucune donn√©e valide');

        fileDiv.querySelector('.file-status-text').textContent = 'üì¶ Enregistrement...';
        progressFill.style.width = '60%';

        let cleanedData = data;
        if (fileKey === "parts") cleanedData = window.cleanPartsData(data);
        if (fileKey === "inventory_parts") cleanedData = window.cleanInventoryPartsData(data);
        if (fileKey === "part_categories") cleanedData = window.cleanCategoriesData(data);
        if (fileKey === "colors") cleanedData = window.cleanColorsData(data);
        if (fileKey === "sets") cleanedData = window.cleanSetsData(data);
        if (fileKey === "inventories") cleanedData = window.cleanInventoriesData(data);
        if (fileKey === "minifigs") cleanedData = window.cleanMinifigsData(data);
        if (fileKey === "inventory_minifigs") cleanedData = window.cleanInventoryMinifigsData(data);

        await db.saveData(fileKey, cleanedData, (current, total) => {
          const percentage = 60 + (current / total) * 40;
          progressFill.style.width = `${percentage}%`;
        });

        await db.setFileDate(fileKey, file.lastModified);

        progressFill.style.width = '100%';
        setTimeout(() => {
          fileDiv.className = 'file-item loaded';
          fileDiv.querySelector('.file-status-text').textContent = '‚úÖ Charg√©';
          fileDiv.querySelector('.file-status-text').className = 'file-status-text loaded';
          progressBar.style.display = 'none';
        }, 500);

        showSuccessMessage(`${file.name}: ${cleanedData.length.toLocaleString()} enregistrements`);

      } catch (error) {
        console.error('Erreur:', error);
        fileDiv.className = 'file-item missing';
        fileDiv.querySelector('.file-status-text').textContent = '‚ùå Erreur';
        fileDiv.querySelector('.file-status-text').className = 'file-status-text missing';
        progressBar.style.display = 'none';
        showErrorMessage(`Erreur avec ${file.name}: ${error.message}`);
      }
    }

    async function removeFile(fileKey) {
      if (confirm(`Supprimer ${REQUIRED_FILES[fileKey].name} ?`)) {
        const transaction = db.db.transaction([fileKey, 'metadata'], 'readwrite');
        await transaction.objectStore(fileKey).clear();
        await transaction.objectStore('metadata').delete(`${fileKey}_last_update`);
        await transaction.objectStore('metadata').delete(`${fileKey}_file_date`);
        await transaction.objectStore('metadata').delete(`${fileKey}_count`);
        
        await updateFileStatus();
        showInfoMessage(`${REQUIRED_FILES[fileKey].name} supprim√©.`);
      }
    }

    async function checkForUpdates() {
      showInfoMessage('Les fichiers Rebrickable sont mis √† jour quotidiennement. Utilisez "üì• T√©l√©charger depuis Rebrickable" pour obtenir la derni√®re version.');
    }

    async function clearAllData() {
      if (confirm('Effacer TOUTES les donn√©es ? Cette action est irr√©versible.')) {
        try {
          await resetDatabase();
          location.reload();
        } catch (error) {
          showErrorMessage(`Erreur: ${error.message}`);
        }
      }
    }

    async function resetDatabase() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.deleteDatabase("LegoPartsDB");
        req.onsuccess = () => resolve();
        req.onerror = reject;
      });
    }

    async function launchApp() {
      const allFilesLoaded = await checkAllFilesLoaded();
      if (allFilesLoaded) {
        navigateTo('menu.html');
      } else {
        showErrorMessage('Tous les fichiers doivent √™tre charg√©s avant de lancer l\'application.');
      }
    }

    async function checkAllFilesLoaded() {
      for (const fileKey of Object.keys(REQUIRED_FILES)) {
        const count = await db.getTableCount(fileKey);
        if (count === 0) return false;
      }
      return true;
    }

    function showErrorMessage(message) {
      showMessage(message, 'error');
    }

    function showInfoMessage(message) {
      showMessage(message, 'info');
    }

    function showSuccessMessage(message) {
      showMessage(message, 'success');
    }

    function showMessage(message, type) {
      const oldMessages = document.querySelectorAll('.temp-message');
      oldMessages.forEach(msg => msg.remove());
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `temp-message ${type === 'success' ? 'success' : type === 'error' ? 'error' : 'update-section'}`;
      messageDiv.innerHTML = `<p>${message}</p>`;
      
      document.body.insertBefore(messageDiv, document.body.firstChild);
      
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 8000);
    }
  </script>

  <!-- SERVICE WORKER -->
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('‚úÖ Service Worker enregistr√©', reg.scope))
        .catch(err => console.error('‚ùå Erreur Service Worker:', err));
    });
  }
  </script>
  <script src="./install-prompt.js"></script>
</body>
</html>