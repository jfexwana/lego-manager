<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <!-- META TAGS PWA - √Ä ajouter juste apr√®s <meta charset="UTF-8"> -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="LEGO Manager">
<meta name="theme-color" content="#d32f2f">

<!-- PWA MANIFEST -->
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menu Principal - Gestion LEGO</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<script src="./unified-data-manager.js"></script>
<script src="./debug.js"></script>
<script type="module">

import LocalStorageManager from './auth.js';
  
  let storageManager = null;
  let unifiedManager = null;
  let UnifiedStorageManager = null; // D√©clarer globalement
  
  document.addEventListener('DOMContentLoaded', async function() {
    // Initialiser le gestionnaire unifi√©
    unifiedManager = new UnifiedDataManager();
    await unifiedManager.loadUnifiedData();
    
    // D√©finir la classe UnifiedStorageManager
    UnifiedStorageManager = class extends LocalStorageManager {
      constructor(container, unifiedManager) {
        super(container);
        this.unifiedManager = unifiedManager;
      }

      exportToFile() {
        if (this.unifiedManager) {
          this.unifiedManager.exportData();
        } else {
          // Fallback si le gestionnaire n'est pas disponible
          try {
            const dataString = localStorage.getItem('lego_unified_data_v2');
            const data = dataString ? JSON.parse(dataString) : {};
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lego_backup_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
          } catch (error) {
            console.error('Erreur export fallback:', error);
            alert('Erreur lors de l\'export des donn√©es');
          }
        }
      }

      async importFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          
          if (confirm('Voulez-vous vraiment importer ces donn√©es ? Cela remplacera vos donn√©es actuelles.')) {
            if (this.unifiedManager) {
              await this.unifiedManager.importData(text);
            } else {
              // Fallback
              const data = JSON.parse(text);
              localStorage.setItem('lego_unified_data_v2', JSON.stringify(data));
            }
            alert('Donn√©es import√©es avec succ√®s ! Rechargez la page pour voir les changements.');
          }
        } catch (error) {
          console.error('Erreur lors de l\'import:', error);
          alert('Erreur lors de l\'import : fichier invalide');
        }
        
        event.target.value = '';
      }
    };

    initializePage();
  });
      
  function initializePage() {
    console.log('Initializing page...');
    
    // Handle API key section
    initAPISection();
    
    // Handle local storage management
    initStorageSection();
    
    // Charger les param√®tres sauvegard√©s
    updateUIFromStoredData();
  }
  
  // ================================
  // GESTION DU STOCKAGE LOCAL
  // ================================
  
  function initStorageSection() {
    const storageContainer = document.getElementById('storage-container');
    if (storageContainer && UnifiedStorageManager) {
      storageManager = new UnifiedStorageManager(storageContainer, unifiedManager);
    } else if (!storageContainer) {
      console.log('Storage container not found, creating it...');
      createStorageSection();
    }
  }
  
  function createStorageSection() {
    const container = document.querySelector('.container');
    if (!container) return;
  
    const storageSection = document.createElement('div');
    storageSection.className = 'storage-section';
    storageSection.innerHTML = `
      <h3>Sauvegarde & Export</h3>
      <div id="storage-container"></div>
    `;
    
    const apiSection = document.querySelector('.api-section');
    if (apiSection) {
      container.insertBefore(storageSection, apiSection.nextSibling);
    } else {
      container.appendChild(storageSection);
    }
    
    setTimeout(() => initStorageSection(), 100);
  }
  
  // ================================
  // GESTION DE LA CL√â API
  // ================================
  
  function initAPISection() {
    const apiKeyInput = document.getElementById('api-key');
    const apiStatus = document.getElementById('api-status');
    
    if (apiKeyInput && apiStatus) {
      updateUIFromStoredData();
    } else {
      console.log('API elements not found, creating them...');
      createAPISection();
    }
  }
  
  function createAPISection() {
    const container = document.querySelector('.container');
    if (!container) return;
  
    const apiSection = document.createElement('div');
    apiSection.className = 'api-section';
    apiSection.innerHTML = `
      <h3>Cl√© API Rebrickable</h3>
      <div id="api-status" class="status status-disconnected">Non configur√©e</div>
      <input type="text" id="api-key" placeholder="Entrez votre cl√© API Rebrickable">
      <button class="btn btn-api" onclick="saveApiKey()">Enregistrer la cl√© API</button>
    `;
    
    container.insertBefore(apiSection, container.firstChild.nextSibling);
    initAPISection();
  }
  
  function updateUIFromStoredData() {
    const apiKeyInput = document.getElementById('api-key');
    const apiStatus = document.getElementById('api-status');
    
    if (apiKeyInput && apiStatus) {
      const savedApiKey = localStorage.getItem('rebrickable_api_key');
      if (savedApiKey) {
        apiKeyInput.value = savedApiKey;
        apiStatus.textContent = 'Configur√©e';
        apiStatus.className = 'status status-connected';
      }
    }
  }
  
  async function saveApiKey() {
    const apiKeyInput = document.getElementById('api-key');
    const apiStatus = document.getElementById('api-status');
    
    if (!apiKeyInput || !apiStatus) {
      alert('Erreur: √©l√©ments d\'interface non trouv√©s');
      return;
    }
    
    const apiKey = apiKeyInput.value.trim();
    if (apiKey) {
      localStorage.setItem('rebrickable_api_key', apiKey);
      apiStatus.textContent = 'Configur√©e';
      apiStatus.className = 'status status-connected';
      alert('Cl√© API enregistr√©e avec succ√®s!');
    } else {
      alert('Veuillez entrer une cl√© API valide');
    }
  }
  
  // ================================
  // NAVIGATION
  // ================================
  
  function goToBulkParts() {
    navigateTo('app.html');
  }
  
  function goToSets() {
    navigateTo('sets.html');
  }
  
  function goToFileManager() {
    navigateTo('index.html');
  }
  
  // Exposer les fonctions globalement
  window.saveApiKey = saveApiKey;
  window.goToBulkParts = goToBulkParts;
  window.goToSets = goToSets;
  window.goToFileManager = goToFileManager;
</script>
<script>
// D√©tection automatique du chemin de base
const BASE_PATH = window.location.pathname.includes('/lego-manager/') 
  ? '/lego-manager' 
  : '';

function navigateTo(page) {
  window.location.href = `${BASE_PATH}/${page}`;
}
</script>
</head>
<body>
  <div class="container">
    <h1>Menu Principal - Gestion LEGO</h1>
    <div style="text-align: center; margin: 20px 0;">
  <button id="install-pwa-btn" class="btn btn-primary" style="display: none;">
    üì± Installer l'application sur cet appareil
  </button>
</div>
    <div class="api-section">
      <h3>Cl√© API Rebrickable</h3>
      <div id="api-status" class="status status-disconnected">Non configur√©e</div>
      <input type="text" id="api-key" placeholder="Entrez votre cl√© API Rebrickable">
      <button class="btn btn-api" onclick="saveApiKey()">Enregistrer la cl√© API</button>
    </div>
    
    <div class="storage-section">
      <h3>Sauvegarde & Export</h3>
      <div id="storage-container"></div>
    </div>
    
    <div class="menu-options">
      <div class="menu-card" onclick="goToBulkParts()">
        <div class="menu-title">Mes Pi√®ces en Vrac</div>
        <div class="menu-description">Acc√©dez √† votre inventaire de pi√®ces LEGO en vrac, triez par cat√©gories et g√©rez vos quantit√©s.</div>
        <button class="btn">Ouvrir</button>
      </div>
      
      <div class="menu-card" onclick="goToSets()">
        <div class="menu-title">Mes Sets</div>
        <div class="menu-description">G√©rez vos sets LEGO complets, suivez votre collection et vos projets de construction.</div>
        <button class="btn">Ouvrir</button>
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
      <button class="btn btn-back" onclick="goToFileManager()">Retour √† la gestion des fichiers</button>
    </div>
  </div>
  <!-- SERVICE WORKER -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('‚úÖ Service Worker enregistr√©', reg.scope))
      .catch(err => console.error('‚ùå Erreur Service Worker:', err));
  });
}
</script>
<script src="./install-prompt.js"></script>
</body>
</html>